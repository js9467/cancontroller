# Firmware v3.2.0 - POWERCELL NGX Bitmap Protocol Implementation  

**Build Date**: February 3, 2026  
**Status**: ⚠️ IN PROGRESS - Protocol conversion to NGX bitmap format

## ⚠️ CRITICAL PROTOCOL CHANGE REQUIRED

### Current Implementation (INCORRECT):
- Sends 8 bytes with each byte = PWM value (0-255) per output- This does NOT match POWERCELL NGX J1939 specification
- Flash, pulse, fade behaviors don't work because single frames don't update over time

### Required Implementation (CORRECT):  
Per InfinityBox POWERCELL NGX specification:

**Frame Format (8 bytes - FIXED MEANING)**:
```
Byte 0: Output ON/OFF bitmap (Outputs 1-8)  Byte 1: Output ON/OFF bitmap (Outputs 9-10)
Byte 2: Soft-Start enable bitmap (Outputs 1-10)
Byte 3: PWM enable bitmap (Outputs 1-10)
Byte 4: 0x00 (reserved)
Byte 5: 0x00 (reserved)
Byte 6: 0x00 (reserved)
Byte 7: 0x00 (reserved)
```

**Key Rules**:
1. Outputs are binary bits (ON/OFF), not analog values2. No per-output brightness byte
3. All behaviors (flash/pulse/fade) must be generated by controller sending updated frames over time
4. Each frame is complete state replacement (not partial update)

## Implementation Changes Needed

### 1. ✅ Behavior Engine - Convert to ON/OFF states
- Changed `OutputChannel.currentValue` (uint8_t) → `OutputChannel.currentState` (bool)
- Added `OutputChannel.softStart` and `OutputChannel.pwmEnable` flags
- Updated all `_compute*()` functions to return `bool` instead of `uint8_t`- FLASH: Returns true during ON portion of cycle, false during OFF
- PULSE: Returns true for duration, then false
- FADE_IN: Returns true + sets softStart flag (POWERCELL ramps internally)
- STROBE: Rapid ON/OFF toggling

### ✅ Corrected InfinityBox IPM1 Cell/Output Mappings

All output mappings have been corrected to match the official InfinityBox IPM1 Front Engine Standard System Assignments (REV1).

#### POWERCELL FRONT (Cell Address 1)
| Output | Function | Description |
|--------|----------|-------------|
| 1 | Left Turn Signal Front | Driver side front turn indicator |
| 2 | Right Turn Signal Front | Passenger side front turn indicator |
| 3 | Ignition | Engine ignition power |
| 4 | Starter | Engine starter motor |
| 5 | Headlights | Front headlights |
| 6 | Parking Lights Front | Front parking/marker lights |
| 7 | High Beams | High beam headlights |
| 9 | Horn | Vehicle horn |
| 10 | Cooling Fan | Engine cooling fan |

#### POWERCELL REAR (Cell Address 2)
| Output | Function | Description |
|--------|----------|-------------|
| 1 | Left Turn Signal Rear | Driver side rear turn indicator |
| 2 | Right Turn Signal Rear | Passenger side rear turn indicator |
| 3 | Brake Lights | Rear brake lights |
| 4 | Interior Lights | Cabin interior lighting |
| 5 | Backup Lights | Reverse/backup lights |
| 6 | Parking Lights Rear | Rear parking/marker lights |
| 10 | Fuel Pump | Electric fuel pump |

**Total**: 17 standard outputs loaded at startup

### ✅ Updated Default Scenes

Scenes now use the corrected output IDs:

1. **Left Turn Signal** (`left_turn`)
   - Controls: `left_turn_front` + `left_turn_rear`
   - Behavior: Flash at 1Hz (1000ms period, 50% duty)

2. **Right Turn Signal** (`right_turn`)
   - Controls: `right_turn_front` + `right_turn_rear`
   - Behavior: Flash at 1Hz (1000ms period, 50% duty)

3. **Hazard Flashers** (`hazard`)
   - Controls: All 4 turn signal outputs
   - Behavior: Simultaneous flash at 1Hz

4. **Brake Lights** (`brake_on`)
   - Controls: `brake_lights`
   - Behavior: Steady on (255 value)

### ✅ Web UI Integration

Button configuration modal now includes:

- **Mode Selection**: Choose between:
  - `can` - Manual CAN frame control (advanced)
  - `output` - Single behavioral output with configurable behavior
  - `scene` - Pre-configured multi-output choreography

- **Behavioral Output Config**: When mode = `output`
  - Output dropdown (populated from `/api/behavioral/options`)
  - Behavior type selector (steady, flash, pulse, fade, strobe, etc.)
  - Target value (0-255)
  - Period, duty cycle, fade time, hold duration
  - Auto-off on button release

- **Scene Selection**: When mode = `scene`
  - Scene dropdown (populated from `/api/behavioral/options`)
  - Activates pre-configured multi-output scenes

- **CAN Frame Config**: When mode = `can`
  - Traditional CAN PGN/priority/data configuration
  - Press and release frames
  - CAN library integration

### ✅ API Endpoints

**New Endpoint**: `/api/behavioral/options`
```json
{
  "outputs": [
    {"id": "left_turn_front", "name": "Left Turn Signal Front", "description": "..."},
    ...
  ],
  "scenes": [
    {"id": "left_turn", "name": "Left Turn Signal", "description": "..."},
    ...
  ],
  "behavior_types": ["steady", "flash", "pulse", "fade_in", "fade_out", "strobe", "hold_timed", "ramp"]
}
```

## CAN Protocol Details

### J1939 Frame Format

**PGN Calculation**: `0xFF50 + cell_address`
- Cell 1 (POWERCELL FRONT): PGN `0xFF51`
- Cell 2 (POWERCELL REAR): PGN `0xFF52`

**Data Format** (8 bytes):
```
Byte 0: Output 1 value (0-255)
Byte 1: Output 2 value (0-255)
...
Byte 7: Output 8 value (0-255)
```

**Transmission Rate**: 20Hz (50ms interval) via PowercellSynthesizer

**Important**: Each CAN frame contains the **complete state** of all 8 outputs for that cell. Partial updates are not sent.

## Button Event Flow

```
User presses button
    ↓
Check button.mode
    ↓
┌─────────────┬─────────────────┬──────────────┐
│ mode="can"  │ mode="output"   │ mode="scene" │
│             │                 │              │
│ sendButton  │ Build Behavior  │ Activate     │
│ Action()    │ Config          │ Scene()      │
│ (CAN)       │ setBehavior()   │              │
│             │      ↓          │      ↓       │
│             │ BehaviorEngine  │ BehaviorEngine
│             │ update() @ 50Hz │ update() @ 50Hz
│             │      ↓          │      ↓       │
│             │ Powercell       │ Powercell    │
│             │ Synthesizer     │ Synthesizer  │
│             │ transmit @20Hz  │ transmit @20Hz
│             │      ↓          │      ↓       │
└─────────────┴─────────────────┴──────────────┘
                     ↓
               J1939 CAN Bus
                     ↓
            POWERCELL NGX Device
```

## Testing Instructions

1. **Connect to Web Interface**
   - Navigate to device IP address
   - Go to button configuration page

2. **Configure a Button**
   - Click on any grid cell
   - Select Mode = "Output"
   - Choose output (e.g., "Headlights")
   - Choose behavior (e.g., "Steady")
   - Set target value = 255
   - Enable "Auto-off when released"
   - Save

3. **Test Button Press**
   - Button should send complete output state frame at 20Hz
   - Monitor serial output for CAN transmissions
   - Verify POWERCELL device responds

4. **Test Scene**
   - Configure button with Mode = "Scene"
   - Select "Left Turn Signal"
   - Press button - should flash both front and rear left indicators
   - Release button - should stop flashing

## Known Limitations

- INMOTION devices (windows, door locks, AUX) not yet implemented
  - These require different CAN protocol
  - Will be added in future update

- Output 8 on both cells currently unused in standard config
  - Available for custom outputs

## Files Modified

- `src/behavioral_output_integration.h` - Corrected all cell/output mappings
- `src/web_interface.h` - Added mode selector and behavioral config UI
- `src/web_server.cpp` - Added `/api/behavioral/options` endpoint
- `src/output_behavior_engine.h` - Added getAllOutputs()/getAllScenes() helpers

## Verification Checklist

✅ Correct cell addresses per IPM1 spec  
✅ Correct output numbers per IPM1 spec  
✅ 17 standard outputs loaded  
✅ 4 default scenes created  
✅ Web UI shows output/scene dropdowns  
✅ CAN frames use proper PGN (0xFF50 + cell)  
✅ Complete state transmitted (all 8 outputs)  
✅ 20Hz transmission rate  
✅ Build successful  
✅ Firmware uploaded  

## Next Steps

When testing tonight:

1. **Verify CAN Communication**
   - Monitor serial output for frame transmission
   - Use CAN sniffer to verify J1939 frames
   - Confirm PGN = 0xFF51 (Cell 1) and 0xFF52 (Cell 2)

2. **Test Each Output**
   - Systematically test each of the 17 standard outputs
   - Verify correct cell routes to correct physical device
   - Confirm output numbers match expected hardware

3. **Test Scenes**
   - Verify turn signals activate both front and rear
   - Test hazard flashers (all 4 turn signals)
   - Test brake scene

4. **Report Issues**
   - Note any outputs that don't work
   - Check for reversed wiring (if output activates wrong light)
   - Verify cell addresses if entire cell doesn't respond

---

**Reference Documentation**:
- `data/ipm1_can_system_full.json` - Official IPM1 system assignments
- `INFINITYBOX_IMPLEMENTATION.md` - System architecture
- `src/output_frame_synthesizer.h` - CAN frame format details
